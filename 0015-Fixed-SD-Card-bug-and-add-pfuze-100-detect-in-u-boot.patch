From 4a68e3fbc0e00cafc53c6b3cb64e6f51c6283233 Mon Sep 17 00:00:00 2001
From: Bingru Tsai <ben_tsai@avalue.com.tw>
Date: Wed, 20 May 2015 10:32:14 +0800
Subject: [PATCH 15/20] Fixed SD Card bug and add pfuze-100 detect in u-boot.

---
 .../board/freescale/mx6q_smarc/mx6q_smarc.c        | 35 ++++++++--------------
 .../uboot-imx/include/configs/mx6_smarc.h          |  4 +--
 kernel_imx/arch/arm/mach-mx6/smarc/rev_sa01.h      |  4 +--
 3 files changed, 17 insertions(+), 26 deletions(-)

diff --git a/bootable/bootloader/uboot-imx/board/freescale/mx6q_smarc/mx6q_smarc.c b/bootable/bootloader/uboot-imx/board/freescale/mx6q_smarc/mx6q_smarc.c
index d1b4ed9..0c8c2f4 100644
--- a/bootable/bootloader/uboot-imx/board/freescale/mx6q_smarc/mx6q_smarc.c
+++ b/bootable/bootloader/uboot-imx/board/freescale/mx6q_smarc/mx6q_smarc.c
@@ -430,64 +430,55 @@ static void setup_i2c(unsigned int module_base)
 
 	switch (module_base) {
 	case I2C1_BASE_ADDR:
-#if defined CONFIG_MX6Q
-		/* i2c1 SDA */
+		#if defined CONFIG_MX6Q
+		/* i2c0 SDA */
 		mxc_iomux_v3_setup_pad(MX6Q_PAD_CSI0_DAT8__I2C1_SDA);
-
-		/* i2c1 SCL */
+		/* i2c0 SCL */
 		mxc_iomux_v3_setup_pad(MX6Q_PAD_CSI0_DAT9__I2C1_SCL);
-#elif defined CONFIG_MX6DL
-		/* i2c1 SDA */
+		#elif defined CONFIG_MX6DL
+		/* i2c0 SDA */
 		mxc_iomux_v3_setup_pad(MX6DL_PAD_CSI0_DAT8__I2C1_SDA);
-		/* i2c1 SCL */
+		/* i2c0 SCL */
 		mxc_iomux_v3_setup_pad(MX6DL_PAD_CSI0_DAT9__I2C1_SCL);
-#endif
-
+		#endif
 		/* Enable i2c clock */
 		reg = readl(CCM_BASE_ADDR + CLKCTL_CCGR2);
 		reg |= 0xC0;
 		writel(reg, CCM_BASE_ADDR + CLKCTL_CCGR2);
-
 		break;
 	case I2C2_BASE_ADDR:
-#if defined CONFIG_MX6Q
+		#if defined CONFIG_MX6Q
 		/* i2c2 SDA */
 		mxc_iomux_v3_setup_pad(MX6Q_PAD_KEY_ROW3__I2C2_SDA);
-
 		/* i2c2 SCL */
 		mxc_iomux_v3_setup_pad(MX6Q_PAD_KEY_COL3__I2C2_SCL);
-#elif defined CONFIG_MX6DL
+		#elif defined CONFIG_MX6DL
 		/* i2c2 SDA */
 		mxc_iomux_v3_setup_pad(MX6DL_PAD_KEY_ROW3__I2C2_SDA);
-
 		/* i2c2 SCL */
 		mxc_iomux_v3_setup_pad(MX6DL_PAD_KEY_COL3__I2C2_SCL);
-#endif
-
+		#endif
 		/* Enable i2c clock */
 		reg = readl(CCM_BASE_ADDR + CLKCTL_CCGR2);
 		reg |= 0x300;
 		writel(reg, CCM_BASE_ADDR + CLKCTL_CCGR2);
-
 		break;
 	case I2C3_BASE_ADDR:
-#if defined CONFIG_MX6Q
+		#if defined CONFIG_MX6Q
 		/* GPIO_3 for I2C3_SCL */
 		mxc_iomux_v3_setup_pad(MX6Q_PAD_GPIO_3__I2C3_SCL);
 		/* GPIO_6 for I2C3_SDA */
 		mxc_iomux_v3_setup_pad(MX6Q_PAD_GPIO_6__I2C3_SDA);
-
-#elif defined CONFIG_MX6DL
+		#elif defined CONFIG_MX6DL
 		/* GPIO_3 for I2C3_SCL */
 		mxc_iomux_v3_setup_pad(MX6DL_PAD_GPIO_3__I2C3_SCL);
 		/* GPIO_6 for I2C3_SDA */
 		mxc_iomux_v3_setup_pad(MX6DL_PAD_GPIO_6__I2C3_SDA);
-#endif
+		#endif
 		/* Enable i2c clock */
 		reg = readl(CCM_BASE_ADDR + CLKCTL_CCGR2);
 		reg |= 0xC00;
 		writel(reg, CCM_BASE_ADDR + CLKCTL_CCGR2);
-
 		break;
 	default:
 		printf("Invalid I2C base: 0x%x\n", module_base);
diff --git a/bootable/bootloader/uboot-imx/include/configs/mx6_smarc.h b/bootable/bootloader/uboot-imx/include/configs/mx6_smarc.h
index b119c84..d0877cd 100644
--- a/bootable/bootloader/uboot-imx/include/configs/mx6_smarc.h
+++ b/bootable/bootloader/uboot-imx/include/configs/mx6_smarc.h
@@ -84,7 +84,7 @@
 #define CONFIG_BOOTP_DNS
 
 //#define CONFIG_CMD_SPI
-//#define CONFIG_CMD_I2C
+#define CONFIG_CMD_I2C
 #define CONFIG_CMD_IMXOTP
 
 /* Enable below configure when supporting nand */
@@ -194,7 +194,7 @@
 #ifdef CONFIG_CMD_I2C
 	#define CONFIG_HARD_I2C         1
 	#define CONFIG_I2C_MXC          1
-	#define CONFIG_SYS_I2C_PORT             I2C2_BASE_ADDR
+	#define CONFIG_SYS_I2C_PORT             I2C1_BASE_ADDR
 	#define CONFIG_SYS_I2C_SPEED            100000
 	#define CONFIG_SYS_I2C_SLAVE            0x8
 	#define CONFIG_MX6_INTER_LDO_BYPASS		0
diff --git a/kernel_imx/arch/arm/mach-mx6/smarc/rev_sa01.h b/kernel_imx/arch/arm/mach-mx6/smarc/rev_sa01.h
index f84ee97..35e5d58 100644
--- a/kernel_imx/arch/arm/mach-mx6/smarc/rev_sa01.h
+++ b/kernel_imx/arch/arm/mach-mx6/smarc/rev_sa01.h
@@ -102,10 +102,10 @@ static const struct esdhc_platform_data mx6q_smarc_sdio2_data __initconst = {
 	.cd_gpio = SMARC_SD2_CD,
 	.wp_gpio = SMARC_SD2_WP,
 	.keep_power_at_suspend = 1,
-	.support_8bit = 1,
+	.support_8bit = 0,
 	.delay_line = 0,
 	.runtime_pm = 1,
-	.cd_type = ESDHC_CD_PERMANENT,
+	.cd_type = ESDHC_CD_CONTROLLER,
 };
 
 static const struct esdhc_platform_data mx6q_smarc_sdio3_data __initconst = {
-- 
1.9.1

